<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoIntel - AI Location Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=JetBrains+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#22d3ee',
                        'primary-dim': '#0e7490',
                        'dark-bg': '#06080d',
                        'dark-surface': '#0d1117',
                        'dark-card': '#131921',
                        'dark-border': '#1e2a3a',
                        'dark-hover': '#1a2332',
                    },
                    fontFamily: {
                        sans: ['DM Sans', 'system-ui', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    }
                }
            }
        }
    </script>
    <style>
        *, *::before, *::after { box-sizing: border-box; }
        body {
            font-family: 'DM Sans', system-ui, sans-serif;
            background: #06080d;
            overflow: hidden;
        }

        /* ── Scrollbar ── */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #1e2a3a; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #2a3a4e; }

        /* ── Noise Texture Overlay ── */
        body::after {
            content: '';
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.018;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
        }

        /* ── Map ── */
        .map-container {
            position: relative;
            height: calc(100vh - 56px);
        }
        #map {
            width: 100%;
            height: 100%;
            background: #06080d;
        }

        /* ── Leaflet Dark Overrides ── */
        .leaflet-control-zoom a {
            background-color: rgba(13, 17, 23, 0.9) !important;
            color: #8b9cb8 !important;
            border-color: #1e2a3a !important;
            backdrop-filter: blur(12px) !important;
            -webkit-backdrop-filter: blur(12px) !important;
            transition: all 0.2s ease !important;
        }
        .leaflet-control-zoom a:hover {
            background-color: rgba(30, 42, 58, 0.9) !important;
            color: #22d3ee !important;
        }
        .leaflet-control-attribution {
            background-color: rgba(6, 8, 13, 0.6) !important;
            color: #3a4a5e !important;
            font-size: 9px !important;
            font-family: 'JetBrains Mono', monospace !important;
            backdrop-filter: blur(8px) !important;
            -webkit-backdrop-filter: blur(8px) !important;
        }
        .leaflet-control-attribution a { color: #0e7490 !important; }
        .leaflet-popup-content-wrapper {
            background-color: rgba(13, 17, 23, 0.95) !important;
            color: #c8d6e5 !important;
            border-radius: 10px !important;
            border: 1px solid #1e2a3a !important;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6), 0 0 20px rgba(34, 211, 238, 0.05) !important;
            backdrop-filter: blur(16px) !important;
            -webkit-backdrop-filter: blur(16px) !important;
        }
        .leaflet-popup-tip { background-color: rgba(13, 17, 23, 0.95) !important; border-top: 1px solid #1e2a3a !important; }
        .leaflet-popup-content { font-family: 'DM Sans', system-ui, sans-serif !important; font-size: 13px !important; line-height: 1.5 !important; }
        .leaflet-popup-content a { color: #22d3ee !important; text-decoration: none !important; }
        .leaflet-popup-content a:hover { text-decoration: underline !important; }
        .leaflet-popup-close-button { color: #3a4a5e !important; font-size: 18px !important; }
        .leaflet-popup-close-button:hover { color: #c8d6e5 !important; }

        /* ── Animations ── */
        @keyframes marker-bounce {
            0%, 100% { transform: translateY(0); }
            15% { transform: translateY(-20px); }
            35% { transform: translateY(-8px); }
            55% { transform: translateY(-3px); }
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.6; }
            50% { transform: scale(1.15); opacity: 0; }
            100% { transform: scale(0.8); opacity: 0; }
        }

        @keyframes scan-line {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100vh); }
        }

        @keyframes fade-up {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes glow-pulse {
            0%, 100% { box-shadow: 0 0 15px rgba(34, 211, 238, 0.08); }
            50% { box-shadow: 0 0 25px rgba(34, 211, 238, 0.15); }
        }

        @keyframes orbit {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes float-subtle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }

        .animate-fade-up {
            animation: fade-up 0.5s cubic-bezier(0.22, 1, 0.36, 1) forwards;
            opacity: 0;
        }

        /* ── Glass Card ── */
        .glass-card {
            background: rgba(13, 17, 23, 0.6);
            border: 1px solid rgba(30, 42, 58, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1);
        }
        .glass-card:hover {
            border-color: rgba(34, 211, 238, 0.15);
            background: rgba(19, 25, 33, 0.7);
        }

        /* ── Upload Zone ── */
        .upload-zone {
            position: relative;
            width: 160px;
            height: 160px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.22, 1, 0.36, 1);
        }
        .upload-zone::before {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            border: 2px dashed rgba(34, 211, 238, 0.3);
            transition: all 0.4s ease;
        }
        .upload-zone::after {
            content: '';
            position: absolute;
            inset: -16px;
            border-radius: 50%;
            border: 1px solid rgba(34, 211, 238, 0.08);
            animation: pulse-ring 3s cubic-bezier(0.22, 1, 0.36, 1) infinite;
        }
        .upload-zone:hover::before {
            border-color: rgba(34, 211, 238, 0.6);
            inset: -5px;
        }
        .upload-zone:hover {
            background: rgba(34, 211, 238, 0.06);
            transform: scale(1.04);
        }
        .upload-zone:hover .upload-icon {
            transform: translateY(-4px);
            color: #22d3ee;
        }
        .upload-icon {
            transition: all 0.4s cubic-bezier(0.22, 1, 0.36, 1);
        }

        /* ── Processing Scanner ── */
        .scanner-orbit {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 2px solid transparent;
            border-top-color: #22d3ee;
            border-right-color: rgba(34, 211, 238, 0.3);
            animation: orbit 1.2s linear infinite;
        }
        .scanner-orbit-outer {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 1px solid transparent;
            border-bottom-color: rgba(34, 211, 238, 0.2);
            border-left-color: rgba(34, 211, 238, 0.1);
            animation: orbit 2s linear infinite reverse;
        }
        .scanner-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22d3ee;
            box-shadow: 0 0 16px rgba(34, 211, 238, 0.6);
        }

        /* ── Drag Over ── */
        .drag-over {
            outline: 2px dashed rgba(34, 211, 238, 0.5) !important;
            outline-offset: -4px;
            background-color: rgba(34, 211, 238, 0.03) !important;
        }

        /* ── Tab ── */
        .tab-btn {
            position: relative;
            transition: all 0.3s ease;
        }
        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0;
            height: 2px;
            background: #22d3ee;
            transition: all 0.3s cubic-bezier(0.22, 1, 0.36, 1);
            transform: translateX(-50%);
        }
        .tab-btn.active {
            color: #22d3ee;
        }
        .tab-btn.active::after {
            width: 100%;
        }

        /* ── Map Controls ── */
        .map-ctrl-btn {
            background: rgba(13, 17, 23, 0.85);
            border: 1px solid #1e2a3a;
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: #8b9cb8;
            transition: all 0.25s ease;
            cursor: pointer;
        }
        .map-ctrl-btn:hover {
            background: rgba(26, 35, 50, 0.9);
            color: #c8d6e5;
            border-color: #2a3a4e;
        }
        .map-ctrl-btn.active {
            background: rgba(34, 211, 238, 0.12);
            color: #22d3ee;
            border-color: rgba(34, 211, 238, 0.3);
        }

        /* ── Coordinate Display ── */
        .coord-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            font-weight: 400;
            letter-spacing: 0.02em;
            color: #c8d6e5;
        }

        /* ── Confidence Badge ── */
        .badge-high {
            background: rgba(16, 185, 129, 0.12);
            color: #34d399;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }
        .badge-medium {
            background: rgba(251, 191, 36, 0.12);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }
        .badge-low {
            background: rgba(248, 113, 113, 0.12);
            color: #f87171;
            border: 1px solid rgba(248, 113, 113, 0.2);
        }

        /* ── Modal ── */
        .modal-backdrop {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .modal-panel {
            background: rgba(13, 17, 23, 0.95);
            border: 1px solid #1e2a3a;
            border-radius: 16px;
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            box-shadow: 0 24px 80px rgba(0,0,0,0.5), 0 0 40px rgba(34, 211, 238, 0.03);
        }

        /* ── Primary Button ── */
        .btn-primary {
            background: linear-gradient(135deg, #0e7490, #0891b2);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 24px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .btn-primary::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, #0891b2, #22d3ee);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .btn-primary:hover::before { opacity: 1; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 24px rgba(34, 211, 238, 0.2); }
        .btn-primary span, .btn-primary i { position: relative; z-index: 1; }

        .btn-ghost {
            background: rgba(30, 42, 58, 0.4);
            color: #8b9cb8;
            border: 1px solid #1e2a3a;
            border-radius: 10px;
            padding: 12px 24px;
            font-weight: 500;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .btn-ghost:hover { background: rgba(30, 42, 58, 0.7); color: #c8d6e5; border-color: #2a3a4e; }

        /* ── Input ── */
        .input-field {
            background: rgba(19, 25, 33, 0.8);
            border: 1px solid #1e2a3a;
            border-radius: 10px;
            color: #c8d6e5;
            padding: 12px 16px;
            font-size: 14px;
            transition: all 0.3s ease;
            width: 100%;
        }
        .input-field::placeholder { color: #3a4a5e; }
        .input-field:focus {
            outline: none;
            border-color: rgba(34, 211, 238, 0.4);
            box-shadow: 0 0 0 3px rgba(34, 211, 238, 0.08);
        }

        /* ── Toast ── */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(13, 17, 23, 0.95);
            border: 1px solid #1e2a3a;
            border-radius: 10px;
            padding: 12px 20px;
            color: #c8d6e5;
            font-size: 13px;
            backdrop-filter: blur(16px);
            z-index: 9000;
            transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1);
            pointer-events: none;
        }
        .toast.show { transform: translateX(-50%) translateY(0); }

        /* ── Results entrance stagger ── */
        .result-card { opacity: 0; }
        .result-card.visible {
            animation: fade-up 0.5s cubic-bezier(0.22, 1, 0.36, 1) forwards;
        }
    </style>
</head>
<body class="text-gray-100 antialiased">

    <!-- Header -->
    <header class="h-14 sticky top-0 z-50 border-b border-dark-border" style="background: rgba(6, 8, 13, 0.85); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);">
        <div class="h-full px-5 flex items-center justify-between">
            <div class="flex items-center space-x-8">
                <div class="flex items-center space-x-2.5">
                    <div class="w-7 h-7 rounded-lg flex items-center justify-center" style="background: linear-gradient(135deg, #0e7490, #22d3ee);">
                        <i class="fas fa-crosshairs text-white text-xs"></i>
                    </div>
                    <span class="text-[15px] font-semibold tracking-tight text-white">GeoIntel</span>
                    <span class="text-[10px] font-mono font-medium tracking-widest uppercase text-cyan-600 ml-1">v2</span>
                </div>
                <nav class="hidden md:flex items-center">
                    <button id="quickSearchBtn" class="text-[13px] text-gray-500 hover:text-gray-300 transition flex items-center gap-1.5">
                        <i class="fas fa-search text-[10px]"></i>
                        Quick Search
                    </button>
                </nav>
            </div>
            <div class="flex items-center space-x-2">
                <button id="apiKeyBtn" class="w-8 h-8 rounded-lg flex items-center justify-center hover:bg-dark-hover transition" title="Gemini API Key">
                    <i class="fas fa-key text-[12px] text-gray-500"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-[2000] hidden">
        <div class="modal-panel p-7 max-w-md w-full mx-4 animate-fade-up">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-9 h-9 rounded-lg flex items-center justify-center" style="background: rgba(34, 211, 238, 0.1); border: 1px solid rgba(34, 211, 238, 0.15);">
                        <i class="fas fa-key text-primary text-sm"></i>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-white">API Configuration</h2>
                        <p class="text-xs text-gray-500">Gemini API Key</p>
                    </div>
                </div>
                <button id="closeApiModal" type="button" class="w-8 h-8 rounded-lg flex items-center justify-center hover:bg-dark-hover transition text-gray-500 hover:text-gray-300">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>

            <div class="mb-5">
                <div class="glass-card p-3 mb-4">
                    <div class="flex items-center gap-2 mb-1">
                        <i class="fas fa-info-circle text-primary text-[11px]"></i>
                        <span class="text-xs text-gray-400">Need an API key?</span>
                    </div>
                    <a href="https://makersuite.google.com/app/apikey" target="_blank"
                       class="text-primary hover:text-cyan-300 text-xs flex items-center gap-1 ml-5 transition">
                        Google AI Studio <i class="fas fa-arrow-right text-[9px]"></i>
                    </a>
                </div>
            </div>

            <div class="mb-5">
                <label for="apiKeyInput" class="block text-xs font-medium text-gray-400 mb-2 tracking-wide uppercase">API Key</label>
                <input type="password" id="apiKeyInput" placeholder="Enter your Gemini API key..." class="input-field">
                <div id="apiKeyStatus" class="mt-2 text-xs hidden"></div>
            </div>

            <div class="flex gap-3">
                <button id="saveApiKeyBtn" type="button" class="flex-1 btn-primary flex items-center justify-center gap-2">
                    <i class="fas fa-check text-xs"></i><span>Save Key</span>
                </button>
                <button id="cancelApiModal" type="button" class="flex-1 btn-ghost text-center">Cancel</button>
            </div>

            <p class="mt-4 text-[11px] text-gray-600 flex items-center gap-1.5">
                <i class="fas fa-lock text-[9px]"></i>
                Stored locally in your browser. Never leaves your device.
            </p>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <span id="toastMsg"></span>
    </div>

    <!-- Main Content -->
    <div class="flex flex-col lg:flex-row" style="height: calc(100vh - 56px);">

        <!-- Map Column -->
        <div class="w-full lg:w-[65%] relative" style="background: #06080d;">
            <div class="map-container" id="mapContainer">
                <div id="map"></div>

                <!-- Upload Overlay -->
                <div id="uploadOverlay" class="absolute inset-0 flex items-center justify-center z-[1000]" style="background: rgba(6, 8, 13, 0.92);">
                    <div class="text-center max-w-sm w-full px-6">
                        <div class="upload-zone mx-auto mb-7 flex items-center justify-center" id="uploadCircle">
                            <i class="fas fa-satellite-dish text-3xl text-gray-500 upload-icon"></i>
                        </div>
                        <h2 class="text-xl font-semibold text-white mb-1.5 tracking-tight">Drop your image</h2>
                        <p class="text-sm text-gray-500 mb-7">or click to browse</p>

                        <div class="space-y-2.5 mb-6">
                            <button id="browseBtn" class="btn-primary w-full flex items-center justify-center gap-2">
                                <i class="fas fa-folder-open text-xs"></i><span>Browse Files</span>
                            </button>
                            <button id="reverseSearchBtn" class="btn-ghost w-full flex items-center justify-center gap-2 text-sm">
                                <i class="fab fa-google text-xs"></i>Reverse Image Search
                            </button>
                        </div>

                        <!-- Context Fields -->
                        <div class="space-y-3 mb-4">
                            <div class="text-left">
                                <label for="contextInput" class="block text-[11px] font-medium text-gray-500 mb-1.5 tracking-wide uppercase">
                                    Context <span class="text-gray-600 normal-case tracking-normal">(optional)</span>
                                </label>
                                <textarea id="contextInput" placeholder="Time period, event, any known details..."
                                    class="input-field resize-none text-sm" rows="2"></textarea>
                            </div>
                            <div class="text-left">
                                <label for="guessInput" class="block text-[11px] font-medium text-gray-500 mb-1.5 tracking-wide uppercase">
                                    Location guess <span class="text-gray-600 normal-case tracking-normal">(optional)</span>
                                </label>
                                <input type="text" id="guessInput" placeholder="e.g. Paris, France" class="input-field text-sm" />
                            </div>
                            <div class="flex justify-end">
                                <button id="clearFieldsBtn" class="text-[11px] text-gray-600 hover:text-gray-400 transition">Clear</button>
                            </div>
                        </div>

                        <input type="file" id="fileInput" accept="image/*" class="hidden">
                        <input type="file" id="reverseSearchInput" accept="image/*" class="hidden">
                        <p class="text-[11px] text-gray-600 mt-5">
                            <i class="fas fa-key text-[9px] mr-1"></i>
                            Configure your Gemini API key to start
                        </p>
                    </div>
                </div>

                <!-- Processing Overlay -->
                <div id="processingOverlay" class="absolute inset-0 flex items-center justify-center z-[1000] hidden" style="background: rgba(6, 8, 13, 0.94);">
                    <div class="text-center">
                        <div class="relative w-[100px] h-[100px] mx-auto mb-6 flex items-center justify-center">
                            <div class="scanner-orbit-outer absolute inset-0 flex items-center justify-center">
                                <div class="scanner-orbit flex items-center justify-center">
                                    <div class="scanner-dot"></div>
                                </div>
                            </div>
                        </div>
                        <p class="text-[15px] font-medium text-white mb-1">Analyzing image</p>
                        <p class="text-sm text-gray-500" id="processingStatus">Initializing AI pipeline...</p>
                    </div>
                </div>

                <!-- Map Controls -->
                <div class="absolute bottom-5 right-5 flex flex-col gap-2 z-[1000]" id="mapControls" style="display: none;">
                    <div class="flex gap-1.5">
                        <button id="mapViewBtn" class="map-ctrl-btn flex items-center gap-1.5">
                            <i class="fas fa-map text-[11px]"></i>Map
                        </button>
                        <button id="streetViewBtn" class="map-ctrl-btn flex items-center gap-1.5">
                            <i class="fas fa-street-view text-[11px]"></i>Street View
                        </button>
                    </div>
                    <select id="mapTypeSelector" class="map-ctrl-btn text-[12px] cursor-pointer appearance-none pr-8" style="background-image: url('data:image/svg+xml,%3Csvg width=&quot;10&quot; height=&quot;6&quot; viewBox=&quot;0 0 10 6&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;%3E%3Cpath d=&quot;M1 1l4 4 4-4&quot; stroke=&quot;%238b9cb8&quot; fill=&quot;none&quot; stroke-width=&quot;1.5&quot;/%3E%3C/svg%3E'); background-repeat: no-repeat; background-position: right 10px center;">
                        <option value="dark">Dark</option>
                        <option value="street">Street</option>
                        <option value="satellite">Satellite</option>
                        <option value="terrain">Terrain</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="w-full lg:w-[35%] border-l border-dark-border overflow-y-auto" style="background: #0a0e15;">

            <!-- Tabs -->
            <div class="border-b border-dark-border flex px-5">
                <button id="resultsTab" class="tab-btn active flex-1 py-3.5 text-[13px] font-medium transition">Results</button>
                <button id="similarTab" class="tab-btn flex-1 py-3.5 text-[13px] font-medium text-gray-600 transition">Similar Images</button>
            </div>

            <!-- Results Content -->
            <div id="resultsContent" class="p-5 space-y-4">
                <div id="noResults" class="text-center py-16">
                    <div class="w-16 h-16 mx-auto mb-5 rounded-2xl flex items-center justify-center" style="background: rgba(19, 25, 33, 0.8); border: 1px solid #1e2a3a;">
                        <i class="fas fa-satellite text-xl text-gray-600"></i>
                    </div>
                    <p class="text-sm text-gray-500 mb-1">No analysis yet</p>
                    <p class="text-xs text-gray-600">Upload an image to begin</p>
                </div>

                <div id="resultsData" class="space-y-4 hidden">

                    <!-- Image Preview -->
                    <div class="result-card glass-card overflow-hidden" style="animation-delay: 0ms;">
                        <img id="uploadedImage" src="" alt="Uploaded" class="w-full h-44 object-cover">
                    </div>

                    <!-- AI Analysis -->
                    <div class="result-card glass-card p-5" style="animation-delay: 80ms;">
                        <div class="flex items-center gap-2.5 mb-3">
                            <div class="w-7 h-7 rounded-lg flex items-center justify-center" style="background: rgba(34, 211, 238, 0.1);">
                                <i class="fas fa-brain text-primary text-[11px]"></i>
                            </div>
                            <h3 class="text-sm font-semibold text-white">AI Analysis</h3>
                        </div>
                        <div id="aiExplanation" class="text-[13px] text-gray-400 leading-[1.7] space-y-2" style="white-space: pre-line;"></div>
                    </div>

                    <!-- User Input Summary -->
                    <div id="userInputSummary" class="result-card glass-card p-5 hidden" style="animation-delay: 120ms;">
                        <div class="flex items-center gap-2.5 mb-3">
                            <div class="w-7 h-7 rounded-lg flex items-center justify-center" style="background: rgba(34, 211, 238, 0.1);">
                                <i class="fas fa-user text-primary text-[11px]"></i>
                            </div>
                            <h3 class="text-sm font-semibold text-white">Your Input</h3>
                        </div>
                        <div class="space-y-2">
                            <div id="providedContext" class="hidden">
                                <span class="text-[11px] text-gray-500 uppercase tracking-wide">Context</span>
                                <p class="text-[13px] text-gray-400 mt-0.5"></p>
                            </div>
                            <div id="providedGuess" class="hidden">
                                <span class="text-[11px] text-gray-500 uppercase tracking-wide">Guess</span>
                                <p class="text-[13px] text-gray-400 mt-0.5"></p>
                            </div>
                        </div>
                    </div>

                    <!-- Location Details -->
                    <div class="result-card glass-card p-5" style="animation-delay: 160ms;">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-sm font-semibold text-white">Location</h3>
                            <span id="confidenceBadge" class="text-[10px] font-mono font-medium px-2.5 py-1 rounded-full badge-high tracking-wide uppercase hidden">High</span>
                        </div>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-[12px] text-gray-500">City</span>
                                <span id="city" class="text-sm font-medium text-white">--</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-[12px] text-gray-500">Country</span>
                                <span id="country" class="text-sm font-medium text-white">--</span>
                            </div>
                            <div class="h-px bg-dark-border my-1"></div>
                            <div class="flex justify-between items-center">
                                <span class="text-[12px] text-gray-500">Lat</span>
                                <div class="flex items-center gap-2">
                                    <span id="latitude" class="coord-value">--</span>
                                    <button class="text-gray-600 hover:text-primary transition text-[11px]" onclick="copyToClipboard(document.getElementById('latitude').textContent)">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-[12px] text-gray-500">Lng</span>
                                <div class="flex items-center gap-2">
                                    <span id="longitude" class="coord-value">--</span>
                                    <button class="text-gray-600 hover:text-primary transition text-[11px]" onclick="copyToClipboard(document.getElementById('longitude').textContent)">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="result-card flex gap-2.5" style="animation-delay: 240ms;">
                        <button id="exportReportBtn" class="btn-primary flex-1 flex items-center justify-center gap-2 text-[13px] py-3">
                            <i class="fas fa-download text-[11px]"></i><span>Export Report</span>
                        </button>
                       
                    </div>

                   

                </div>
            </div>

            <!-- Similar Images Content -->
            <div id="similarContent" class="p-5 hidden">
                <div id="noSimilarImages" class="text-center py-16">
                    <div class="w-16 h-16 mx-auto mb-5 rounded-2xl flex items-center justify-center" style="background: rgba(19, 25, 33, 0.8); border: 1px solid #1e2a3a;">
                        <i class="fas fa-images text-xl text-gray-600"></i>
                    </div>
                    <p class="text-sm text-gray-500 mb-1">No reverse search yet</p>
                    <p class="text-xs text-gray-600 mb-5">Results appear after analysis</p>
                    <button id="performReverseSearch" class="btn-primary hidden">
                        <i class="fab fa-google text-xs mr-2"></i><span>Search with Google Lens</span>
                    </button>
                </div>
                <div id="similarImagesResults" class="space-y-4 hidden">
                    <div class="glass-card p-4">
                        <h3 class="text-sm font-semibold text-white mb-1 flex items-center gap-2">
                            <i class="fab fa-google text-primary text-xs"></i>
                            Reverse Image Search
                        </h3>
                        <p class="text-xs text-gray-500 mb-3">Find similar images and sources</p>
                        <button id="openGoogleLens" class="btn-primary w-full flex items-center justify-center gap-2 text-[13px]">
                            <i class="fas fa-external-link-alt text-[10px]"></i><span>Open in Google Lens</span>
                        </button>
                    </div>
                    <div id="reverseSearchResults" class="grid grid-cols-1 gap-3"></div>
                </div>
            </div>

        </div>
    </div>

    <script>
        let map;
        let marker;
        let currentTileLayer;
        let currentImageFile = null;
        let currentAnalysisResult = null;
        let currentLocationLat = null;
        let currentLocationLng = null;

        const API_BASE_URL = window.location.origin;
        const STORAGE_KEYS = { API_KEY: 'geointel_gemini_api_key' };

        const TILE_LAYERS = {
            dark: {
                url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/">CARTO</a>',
                options: { subdomains: 'abcd', maxZoom: 20 }
            },
            street: {
                url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                options: { maxZoom: 19 }
            },
            satellite: {
                url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',
                attribution: '&copy; Esri',
                options: { maxZoom: 18 }
            },
            terrain: {
                url: 'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
                attribution: '&copy; <a href="https://opentopomap.org">OpenTopoMap</a>',
                options: { maxZoom: 17 }
            }
        };

        // ── Toast ──
        function showToast(msg, duration = 2500) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMsg').textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), duration);
        }

        // ── Map ──
        function initMap() {
            map = L.map('map', { center: [20, 0], zoom: 2, zoomControl: true });
            setTileLayer('dark');
        }

        function setTileLayer(name) {
            const layer = TILE_LAYERS[name];
            if (!layer) return;
            if (currentTileLayer) map.removeLayer(currentTileLayer);
            currentTileLayer = L.tileLayer(layer.url, { attribution: layer.attribution, ...layer.options }).addTo(map);
        }

        // ── Tabs ──
        const resultsTab = document.getElementById('resultsTab');
        const similarTab = document.getElementById('similarTab');
        const resultsContent = document.getElementById('resultsContent');
        const similarContent = document.getElementById('similarContent');

        resultsTab.addEventListener('click', () => {
            resultsTab.classList.add('active'); resultsTab.classList.remove('text-gray-600');
            similarTab.classList.remove('active'); similarTab.classList.add('text-gray-600');
            resultsContent.classList.remove('hidden'); similarContent.classList.add('hidden');
        });
        similarTab.addEventListener('click', () => {
            similarTab.classList.add('active'); similarTab.classList.remove('text-gray-600');
            resultsTab.classList.remove('active'); resultsTab.classList.add('text-gray-600');
            similarContent.classList.remove('hidden'); resultsContent.classList.add('hidden');
        });

        // ── Upload ──
        const fileInput = document.getElementById('fileInput');
        const browseBtn = document.getElementById('browseBtn');
        const uploadCircle = document.getElementById('uploadCircle');
        const mapContainer = document.getElementById('mapContainer');
        const uploadOverlay = document.getElementById('uploadOverlay');
        const processingOverlay = document.getElementById('processingOverlay');
        const quickSearchBtn = document.getElementById('quickSearchBtn');

        browseBtn.addEventListener('click', () => fileInput.click());
        uploadCircle.addEventListener('click', () => fileInput.click());
        quickSearchBtn.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileUpload);

        document.getElementById('clearFieldsBtn').addEventListener('click', () => {
            document.getElementById('contextInput').value = '';
            document.getElementById('guessInput').value = '';
        });

        mapContainer.addEventListener('dragover', (e) => { e.preventDefault(); mapContainer.classList.add('drag-over'); });
        mapContainer.addEventListener('dragleave', () => mapContainer.classList.remove('drag-over'));
        mapContainer.addEventListener('drop', (e) => {
            e.preventDefault();
            mapContainer.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) processImage(file);
        });

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (file) { currentImageFile = file; processImage(file); }
        }

        // ── API Key ──
        function getStoredApiKey() { return localStorage.getItem(STORAGE_KEYS.API_KEY); }
        function storeApiKey(key) { localStorage.setItem(STORAGE_KEYS.API_KEY, key); updateApiKeyIndicator(); }

        function updateApiKeyIndicator() {
            const icon = document.getElementById('apiKeyBtn').querySelector('i');
            if (getStoredApiKey()) { icon.classList.remove('text-gray-500'); icon.classList.add('text-emerald-400'); }
            else { icon.classList.remove('text-emerald-400'); icon.classList.add('text-gray-500'); }
        }

        function showApiKeyModal() {
            document.getElementById('apiKeyModal').classList.remove('hidden');
            const saved = getStoredApiKey();
            if (saved) document.getElementById('apiKeyInput').value = saved;
        }
        function hideApiKeyModal() { document.getElementById('apiKeyModal').classList.add('hidden'); }

        function showApiKeyStatus(msg, isError = false) {
            const el = document.getElementById('apiKeyStatus');
            el.textContent = msg;
            el.className = `mt-2 text-xs ${isError ? 'text-red-400' : 'text-emerald-400'}`;
            el.classList.remove('hidden');
        }

        function openGoogleReverseSearch() {
            window.open('https://lens.google.com/', '_blank');
            showToast('Google Lens opened in new tab');
        }

        // ── Processing Status Animation ──
        const processingMessages = [
            'Initializing AI pipeline...',
            'Scanning visual features...',
            'Analyzing text & signage...',
            'Evaluating architecture...',
            'Cross-referencing location data...',
            'Narrowing coordinates...',
            'Validating results...'
        ];
        let processingInterval = null;

        function startProcessingAnimation() {
            let idx = 0;
            const statusEl = document.getElementById('processingStatus');
            statusEl.textContent = processingMessages[0];
            processingInterval = setInterval(() => {
                idx = (idx + 1) % processingMessages.length;
                statusEl.style.opacity = '0';
                setTimeout(() => {
                    statusEl.textContent = processingMessages[idx];
                    statusEl.style.opacity = '1';
                }, 200);
            }, 2200);
        }

        function stopProcessingAnimation() {
            if (processingInterval) { clearInterval(processingInterval); processingInterval = null; }
        }

        // ── Process Image ──
        async function processImage(file) {
            const apiKey = getStoredApiKey();
            if (!apiKey) { showToast('Configure your Gemini API key first'); showApiKeyModal(); return; }

            uploadOverlay.classList.add('hidden');
            processingOverlay.classList.remove('hidden');
            startProcessingAnimation();

            const reader = new FileReader();
            reader.onload = async (e) => {
                document.getElementById('uploadedImage').src = e.target.result;
                const contextValue = document.getElementById('contextInput').value.trim();
                const guessValue = document.getElementById('guessInput').value.trim();

                try {
                    const response = await fetch(`${API_BASE_URL}/api/analyze`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            image: e.target.result,
                            api_key: apiKey,
                            context: contextValue || null,
                            guess: guessValue || null
                        })
                    });
                    const result = await response.json();
                    stopProcessingAnimation();
                    if (response.ok && !result.error) { showResults(result); }
                    else {
                        processingOverlay.classList.add('hidden');
                        uploadOverlay.classList.remove('hidden');
                        showToast(`Error: ${result.error || 'Analysis failed'}`);
                    }
                } catch (error) {
                    stopProcessingAnimation();
                    processingOverlay.classList.add('hidden');
                    uploadOverlay.classList.remove('hidden');
                    showToast(`Network error: ${error.message}`);
                }
            };
            reader.readAsDataURL(file);
        }

        // ── Show Results ──
        function showResults(analysisResult) {
            processingOverlay.classList.add('hidden');
            currentAnalysisResult = analysisResult;

            document.getElementById('noResults').classList.add('hidden');
            document.getElementById('resultsData').classList.remove('hidden');
            document.getElementById('mapControls').style.display = 'flex';
            document.getElementById('performReverseSearch').classList.remove('hidden');
            document.getElementById('similarImagesResults').classList.remove('hidden');

            const locations = analysisResult.locations || [];
            const interpretation = analysisResult.interpretation || 'No interpretation available';

            // User input
            const ctx = document.getElementById('contextInput').value.trim();
            const guess = document.getElementById('guessInput').value.trim();
            if (ctx || guess) {
                document.getElementById('userInputSummary').classList.remove('hidden');
                if (ctx) { document.getElementById('providedContext').classList.remove('hidden'); document.querySelector('#providedContext p').textContent = ctx; }
                else document.getElementById('providedContext').classList.add('hidden');
                if (guess) { document.getElementById('providedGuess').classList.remove('hidden'); document.querySelector('#providedGuess p').textContent = guess; }
                else document.getElementById('providedGuess').classList.add('hidden');
            } else {
                document.getElementById('userInputSummary').classList.add('hidden');
            }

            if (locations.length > 0) {
                const loc = locations[0];
                const coords = loc.coordinates || { latitude: 0, longitude: 0 };
                currentLocationLat = coords.latitude;
                currentLocationLng = coords.longitude;

                document.getElementById('aiExplanation').innerHTML = formatAnalysis(interpretation);
                document.getElementById('latitude').textContent = coords.latitude.toFixed(6);
                document.getElementById('longitude').textContent = coords.longitude.toFixed(6);
                document.getElementById('city').textContent = loc.city || 'Unknown';
                document.getElementById('country').textContent = loc.country || 'Unknown';

                // Confidence badge
                const badge = document.getElementById('confidenceBadge');
                const conf = (loc.confidence || 'Medium').toLowerCase();
                badge.textContent = loc.confidence || 'Medium';
                badge.className = `text-[10px] font-mono font-medium px-2.5 py-1 rounded-full tracking-wide uppercase badge-${conf}`;

                // Copy buttons
                document.getElementById('latitude').nextElementSibling.onclick = () => copyToClipboard(coords.latitude.toFixed(6));
                document.getElementById('longitude').nextElementSibling.onclick = () => copyToClipboard(coords.longitude.toFixed(6));

                // Map marker
                const title = `${loc.city || 'Unknown'}, ${loc.country || 'Unknown'}`;
                if (marker) map.removeLayer(marker);

                marker = L.marker([coords.latitude, coords.longitude])
                    .addTo(map)
                    .bindPopup(`<strong style="font-size:13px;">${title}</strong><br><span style="font-family:'JetBrains Mono',monospace;font-size:11px;color:#8b9cb8;">${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}</span><br><a href="https://www.google.com/maps?q=${coords.latitude},${coords.longitude}" target="_blank" style="font-size:11px;">Open in Google Maps &rarr;</a>`)
                    .openPopup();

                const el = marker.getElement();
                if (el) {
                    el.style.animation = 'marker-bounce 0.6s ease-out';
                    el.addEventListener('animationend', () => el.style.animation = '', { once: true });
                }

                map.setView([coords.latitude, coords.longitude], 15);

                // Staggered card reveal
                requestAnimationFrame(() => {
                    document.querySelectorAll('.result-card').forEach((card, i) => {
                        setTimeout(() => card.classList.add('visible'), i * 80);
                    });
                });

            } else {
                showToast('No location could be determined');
                uploadOverlay.classList.remove('hidden');
            }
        }

        function openInGoogleMaps(lat, lng) { window.open(`https://www.google.com/maps?q=${lat},${lng}`, '_blank'); }

        function openStreetView() {
            if (currentLocationLat !== null && currentLocationLng !== null) {
                window.open(`https://www.google.com/maps/@?api=1&map_action=pano&viewpoint=${currentLocationLat},${currentLocationLng}`, '_blank');
            } else { showToast('Analyze an image first'); }
        }

        function exportReport() {
            if (!currentAnalysisResult) { showToast('No results to export'); return; }
            const locations = currentAnalysisResult.locations || [];
            const interpretation = currentAnalysisResult.interpretation || '';
            if (!locations.length) { showToast('No location data'); return; }
            const loc = locations[0];
            const coords = loc.coordinates || { latitude: 0, longitude: 0 };

            const report = `GeoIntel Location Analysis Report\n${'='.repeat(36)}\nGenerated: ${new Date().toLocaleString()}\n\nAI ANALYSIS\n${'-'.repeat(11)}\n${interpretation}\n\nLOCATION DETAILS\n${'-'.repeat(16)}\nLatitude: ${coords.latitude.toFixed(6)}\nLongitude: ${coords.longitude.toFixed(6)}\nCity: ${loc.city || 'Unknown'}\nCountry: ${loc.country || 'Unknown'}\nConfidence: ${loc.confidence || 'Medium'}\n\nCOORDINATES\n${'-'.repeat(11)}\nDecimal: ${coords.latitude.toFixed(6)}, ${coords.longitude.toFixed(6)}\nGoogle Maps: https://www.google.com/maps?q=${coords.latitude},${coords.longitude}\n\nMETADATA\n${'-'.repeat(8)}\nDate: ${new Date().toISOString()}\nSource: GeoIntel AI Location Intelligence`;

            const blob = new Blob([report], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `geointel_report_${Date.now()}.txt`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Report exported');
        }

        // ── Map Controls ──
        const mapViewBtn = document.getElementById('mapViewBtn');
        const streetViewBtn = document.getElementById('streetViewBtn');

        mapViewBtn.addEventListener('click', () => {
            if (currentLocationLat !== null) map.setView([currentLocationLat, currentLocationLng], 15);
            mapViewBtn.classList.add('active'); streetViewBtn.classList.remove('active');
        });
        streetViewBtn.addEventListener('click', openStreetView);

        document.getElementById('mapTypeSelector').addEventListener('change', (e) => setTileLayer(e.target.value));

        // ── Format Analysis Text ──
        function formatAnalysis(text) {
            if (!text) return '';
            // Sanitize HTML entities to prevent XSS
            const safe = text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            // Split on existing newlines or sentence boundaries for readability
            const lines = safe.split(/\n+/).filter(l => l.trim());
            if (lines.length > 1) {
                return lines.map(l => `<p>${l.trim()}</p>`).join('');
            }
            // Single block — split into sentences, group into short paragraphs
            const sentences = safe.match(/[^.!?]+[.!?]+/g) || [safe];
            if (sentences.length <= 3) {
                return `<p>${sentences.join(' ').trim()}</p>`;
            }
            const mid = Math.ceil(sentences.length / 2);
            return `<p>${sentences.slice(0, mid).join(' ').trim()}</p><p>${sentences.slice(mid).join(' ').trim()}</p>`;
        }

        // ── Utility ──
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => showToast('Copied to clipboard'));
        }

        function submitFeedback(type) {
            const msgs = { happy: 'Thanks! Glad it was accurate', neutral: 'Thanks for the feedback', sad: 'Sorry about that. We\'ll improve' };
            showToast(msgs[type] || 'Thanks for feedback');
        }

        // ── API Key Modal ──
        document.getElementById('apiKeyBtn').addEventListener('click', showApiKeyModal);
        document.getElementById('closeApiModal').addEventListener('click', hideApiKeyModal);
        document.getElementById('cancelApiModal').addEventListener('click', hideApiKeyModal);

        document.getElementById('saveApiKeyBtn').addEventListener('click', () => {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key) { showApiKeyStatus('Please enter a valid API key', true); return; }
            storeApiKey(key);
            showApiKeyStatus('Saved successfully!', false);
            setTimeout(hideApiKeyModal, 1200);
        });

        // ── Export & Search Listeners ──
        document.getElementById('exportReportBtn').addEventListener('click', exportReport);
        document.getElementById('reverseSearchBtn').addEventListener('click', () => document.getElementById('reverseSearchInput').click());
        document.getElementById('reverseSearchInput').addEventListener('change', (e) => { if (e.target.files[0]) openGoogleReverseSearch(); });
        document.getElementById('openGoogleLens').addEventListener('click', openGoogleReverseSearch);
        document.getElementById('performReverseSearch').addEventListener('click', openGoogleReverseSearch);

        // ── Init ──
        window.addEventListener('load', () => {
            updateApiKeyIndicator();
            if (!getStoredApiKey()) setTimeout(showApiKeyModal, 600);
        });

        document.addEventListener('DOMContentLoaded', initMap);
    </script>
</body>
</html>
